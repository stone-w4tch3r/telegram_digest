{% extends "base.html" %}

{% block title %}Channels - Telegram Digest{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Add Channel</h2>
    </div>
    <form action="/channels/add" method="POST">
        <div class="form-group">
            <label for="channel_name">Channel Name</label>
            <input 
                type="text" 
                id="channel_name" 
                name="channel_name" 
                required 
                placeholder="e.g., channelname"
            >
        </div>
        <div class="form-group">
            <label for="channel_url">Channel URL</label>
            <input 
                type="url" 
                id="channel_url" 
                name="channel_url" 
                required 
                placeholder="https://t.me/channelname"
            >
        </div>
        <button type="submit" class="btn btn-primary">Add Channel</button>
    </form>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Your Channels</h2>
    </div>
    <div class="channel-list">
        {% if channels %}
            {% for channel in channels %}
                <div class="channel-card" id="channel-{{ channel.id }}">
                    <h3>{{ channel.name }}</h3>
                    <p>{{ channel.url }}</p>
                    <div class="channel-actions">
                        <button 
                            class="btn btn-primary"
                            onclick="generateDigest('{{ channel.id }}')"
                        >
                            Generate Digest
                        </button>
                        <button 
                            class="btn btn-danger"
                            onclick="removeChannel('{{ channel.id }}')"
                        >
                            Remove
                        </button>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p>No channels added yet. Add your first channel above.</p>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    async function generateDigest(channelId) {
        try {
            const response = await fetch(`/api/digests/generate?channel_id=${channelId}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (response.ok) {
                showAlert('Digest generated successfully!');
            } else {
                showAlert(data.message || 'Failed to generate digest', 'error');
            }
        } catch (error) {
            showAlert('Failed to generate digest', 'error');
        }
    }

    async function removeChannel(channelId) {
        if (!confirmAction('Are you sure you want to remove this channel?')) {
            return;
        }

        try {
            const response = await fetch(`/api/channels/${channelId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                const channelElement = document.getElementById(`channel-${channelId}`);
                channelElement.remove();
                showAlert('Channel removed successfully');
            } else {
                const data = await response.json();
                showAlert(data.message || 'Failed to remove channel', 'error');
            }
        } catch (error) {
            showAlert('Failed to remove channel', 'error');
        }
    }
</script>
{% endblock %}
